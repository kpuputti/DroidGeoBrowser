/*
 JSONCache version 0.0.3

 Author: Kimmo Puputti (kpuputti at gmail)

 See README.rst at https://github.com/kpuputti/JSONCache
 for requirements and usage.
*/
(function(m){var i={version:"0.0.3",debug:!0,numTries:5,waitTime:200,itemLifetime:3E5},j=function(){if(i.debug&&window.console){var b=Array.prototype.slice.call(arguments);b.unshift("JSONCache:");console.log.apply(console,b)}};i.browserOk=function(){var b=window.JSON&&typeof window.JSON.parse==="function"&&typeof window.JSON.stringify==="function",a;try{a="localStorage"in window&&window.localStorage!==null}catch(c){a=!1}return b&&a}();var k=function(b,a){try{window.localStorage[b]=a}catch(c){j("Error adding data to localStorage, quota might be full.")}},
f={};f.settings=i;var l=function(b){b=parseInt(b,10);return!isNaN(b)&&b+i.itemLifetime>=f._getTime()};f.clear=function(b){if(b)window.localStorage.removeItem("JSONCache data "+b),window.localStorage.removeItem("JSONCache time "+b);else{var b=/^JSONCache (data|time) /,a,c,e=window.localStorage.length,d=[];for(a=0;a<e;++a)c=window.localStorage.key(a),b.test(c)&&d.push(c);e=d.length;for(a=0;a<e;++a)window.localStorage.removeItem(d[a])}};f.clean=function(){var b=/^JSONCache time ([\S]+)$/,a,c,e=[],d,
g=window.localStorage.length;for(d=0;d<g;++d)a=window.localStorage.key(d),(c=b.exec(a))&&!l(window.localStorage[a])&&e.push(c[1]);g=e.length;for(d=0;d<g;++d)f.clear(e[d])};f.purgeOldest=function(){for(var b=/^JSONCache time /,a,c=null,e,d,f=window.localStorage.length,h=0;h<f;++h)if(e=window.localStorage.key(h),b.test(e)&&(d=parseInt(window.localStorage[e],10),!isNaN(d)&&(c===null||d<c)))a=e,c=d;c!==null&&(window.localStorage.removeItem(a.replace(" time "," data ")),window.localStorage.removeItem(a))};
f._getJSONProxy=function(b,a){m.ajax(b,a)};f._getTime=function(){return(new Date).getTime()};f._tryGetJSON=function(b,a,c,e){c>i.numTries?(j("Tried fetching",c-1,"times already, returning."),typeof a.JSONCacheError==="function"&&a.JSONCacheError("timeout")):(a.error=function(d,g,h){j("Ajax error with status:",g);typeof a.errorHook==="function"&&a.errorHook(d,g,h,c);window.setTimeout(function(){f._tryGetJSON(b,a,c+1,e*2)},e)},typeof a.retryHook==="function"&&a.retryHook(c),f._getJSONProxy(b,a))};f.getCachedJSON=
function(b,a){a=a||{};(new Date).getTime();var c=a.success,e="JSONCache data "+b,d="JSONCache time "+b,g=window.localStorage[e],h=window.localStorage[d];g&&l(h)?(j("Value found from cache for url:",b),c(JSON.parse(g))):(j("Value not found in cache fetching data from url:",b),a.success=function(a){j("Fetched data, adding to cache for url:",b);k(e,JSON.stringify(a));k(d,f._getTime());c(a)},a.dataType="json",f._tryGetJSON(b,a,1,i.waitTime))};window.JSONCache=f})(jQuery);
